<script type="text/javascript">
    RED.nodes.registerType('miio-moonlight', {
        category: 'Xiaomi miIO',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            deviceId: {value:""},
            manEnabled : {value: false},
            manDeviceIp: {value:""},
            manDeviceToken: {value:""}
        },
        inputs:1,
        outputs: 1,
        icon: "debug.png",
        label: function() {
            return this.name||"miio-moonlight";
        },
        paletteLabel: "Philips Zhirui",
        oneditprepare: function() {
            var node = this;
            
            for (key in RED.settings.miioMoonlightDevices) {
                var device = RED.settings.miioMoonlightDevices[key];
                if (device.model.indexOf('moonlight') !== -1) {
                    $('#node-input-deviceId').append('<option value="' + device.id + '">' + device.id + ' ' + device.address + '</option>');
                }
            }
            
            $('#node-input-manEnabled').change(function() {
                $('#node-input-deviceId').prop('disabled', this.checked);
                $('#node-input-manDeviceIp').prop('disabled', !this.checked);
                $('#node-input-manDeviceToken').prop('disabled', !this.checked);
            });

            $('#node-input-deviceId').val(node.deviceId);
            $('#node-input-manEnabled').checked = node.manEnabled;
            $('#node-input-manDeviceIp').val(node.manDeviceIp);
            $('#node-input-manDeviceToken').val(node.manDeviceToken);

        },
        oneditsave: function() {
            var node = this;
            node.deviceId = $('#node-input-deviceId').val();
            node.manEnabled = $('#node-input-manEnabled').checked;
            node.manDeviceIp = $('#node-input-manDeviceIp').val();
            node.manDeviceToken = $('#node-input-manDeviceToken').val();

            if(node.manEnabled) {
                node.deviceId = "";
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="miio-moonlight">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-deviceId"><i class="icon-tag"></i> Device</label>
        <select type="text" id="node-input-deviceId" placeholder="ex: 158d0001a2ca33"></select>
        <!-- <input type="text" id="node-input-deviceId" placeholder="ex: 158d0001a2ca33"> -->
    </div>
    <div class="form-row">
        <label for="node-input-manEnabled"><i class="icon-tag"></i> Manual Device Setup</label>
        <input type="checkbox" id="node-input-manEnabled">
    </div>
    <div class="form-row">
        <label for="node-input-manDeviceIp"><i class="icon-tag"></i> IP</label>
        <input type="text" id="node-input-manDeviceIp" placeholder="ex: 192.168.0.1">
    </div>
    <div class="form-row">
        <label for="node-input-manDeviceToken"><i class="icon-tag"></i> Token</label>
        <input type="text" id="node-input-manDeviceToken" placeholder="token">
    </div>
</script>

<script type="text/x-red" data-help-name="miio-moonlight">
    <p>Xiaomi Moonlight</p>
    Output device, inject JSON payload to set Moonlight properties.
    Sample JSON:
    <pre><code>payload: {power: true, ...}</code></pre>
</script>